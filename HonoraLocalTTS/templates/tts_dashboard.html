<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Honora TTS Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap');

        :root {
            --bg: #0c0f16;
            --panel: rgba(20, 24, 34, 0.8);
            --panel-strong: rgba(32, 38, 52, 0.9);
            --border: rgba(255, 255, 255, 0.08);
            --text: #e8ecf8;
            --muted: #9aa4bd;
            --accent: #7dd3fc;
            --accent-2: #a855f7;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
            --shadow: 0 25px 80px rgba(0, 0, 0, 0.35);
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at 20% 20%, rgba(125, 211, 252, 0.08), transparent 25%),
                radial-gradient(circle at 80% 0%, rgba(168, 85, 247, 0.1), transparent 30%),
                linear-gradient(135deg, #0b1020, #0c0f16 40%, #0b1121 80%);
            color: var(--text);
            font-family: 'Space Grotesk', sans-serif;
            padding: 32px 16px;
            display: flex;
            justify-content: center;
        }

        .page {
            width: 100%;
            max-width: 1400px;
        }

        .hero {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 28px;
            margin-bottom: 16px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            background: linear-gradient(120deg, rgba(125, 211, 252, 0.15), rgba(168, 85, 247, 0.15));
            border: 1px solid var(--border);
            font-size: 12px;
        }

        h1 {
            margin: 12px 0 8px;
            font-size: 28px;
            font-weight: 600;
        }

        h2 {
            margin: 0 0 12px;
            font-size: 18px;
            font-weight: 600;
        }

        .muted {
            color: var(--muted);
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: 340px 1fr 400px;
            gap: 16px;
        }

        .card {
            background: var(--panel-strong);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        select,
        input[type="file"],
        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 12px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        select option {
            background: #1a1f2e;
        }

        button {
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        button.primary {
            background: linear-gradient(120deg, var(--accent), var(--accent-2));
            color: #0b1020;
        }

        button.primary:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        button.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        button.success {
            background: var(--success);
            color: #0b1020;
        }

        button.warning {
            background: var(--warning);
            color: #0b1020;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .engine-card {
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px solid var(--border);
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.15s;
        }

        .engine-card:hover {
            border-color: var(--accent);
        }

        .engine-card.selected {
            border-color: var(--accent);
            background: rgba(125, 211, 252, 0.1);
        }

        .engine-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .engine-name {
            font-weight: 600;
            font-size: 14px;
        }

        .engine-desc {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        .chapter-list,
        .section-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .chapter-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.15s;
        }

        .chapter-item:hover {
            border-color: var(--accent);
        }

        .chapter-item.selected {
            border-color: var(--accent);
            background: rgba(125, 211, 252, 0.1);
        }

        .chapter-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--muted);
            flex-shrink: 0;
        }

        .chapter-item.complete .chapter-status {
            background: var(--success);
        }

        .chapter-item.partial .chapter-status {
            background: var(--warning);
        }

        .chapter-item.processing .chapter-status {
            background: var(--accent);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .chapter-info {
            flex: 1;
            min-width: 0;
        }

        .chapter-title {
            font-weight: 600;
            font-size: 14px;
        }

        .chapter-meta {
            font-size: 12px;
            color: var(--muted);
        }

        .section-item {
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .section-item.has-audio {
            border-color: var(--success);
        }

        .section-item.title {
            border-color: var(--accent);
            background: rgba(125, 211, 252, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .section-index {
            font-weight: 600;
            font-size: 12px;
            color: var(--accent);
        }

        .section-chars {
            font-size: 11px;
            color: var(--muted);
        }

        .section-text {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text);
            max-height: 60px;
            overflow: hidden;
        }

        .section-audio {
            margin-top: 8px;
        }

        .section-audio audio {
            width: 100%;
            height: 32px;
        }

        .progress-container {
            margin-top: 16px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            transition: width 0.3s;
        }

        .log {
            margin-top: 12px;
            font-size: 12px;
            color: var(--muted);
            max-height: 100px;
            overflow-y: auto;
        }

        .test-box {
            margin-top: 16px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid var(--border);
        }
    </style>
</head>

<body>
    <main class="page">
        <!-- Hero -->
        <section class="hero">
            <span class="badge">üéôÔ∏è TTS Dashboard ¬∑ Multi-Engine</span>
            <h1>Honora Audio Generator</h1>
            <p class="muted">Generate audiobook audio with multiple TTS engines. Choose based on your needs.</p>
            <div id="status-bar" style="margin-top: 12px; display: flex; gap: 16px; flex-wrap: wrap;">
                <span id="status-supabase" class="badge" style="opacity: 0.5;">‚è≥ Supabase</span>
                <span id="status-queue" class="badge" style="opacity: 0.5;">‚è≥ Queue</span>
            </div>
        </section>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Left: Controls -->
            <div class="card">
                <h2>üîß TTS Engine</h2>
                <div id="engine-list"></div>

                <h2 style="margin-top: 16px;">üìö Select Book</h2>
                <select id="book-select">
                    <option value="">Loading books...</option>
                </select>

                <h2 style="margin-top: 16px;">üé§ Voice</h2>
                <select id="voice-select">
                    <option value="">Select voice...</option>
                </select>

                <h2 style="margin-top: 16px;">üåç Language</h2>
                <select id="language-select">
                    <option value="en">English</option>
                    <option value="da">Dansk</option>
                    <option value="de">Deutsch</option>
                    <option value="es">Espa√±ol</option>
                    <option value="fr">Fran√ßais</option>
                </select>

                <h2 style="margin-top: 16px;">üéöÔ∏è Generate</h2>
                <div class="btn-group">
                    <button class="secondary" id="test-1-btn">Test 1</button>
                    <button class="secondary" id="test-3-btn">Test 3</button>
                    <button class="primary" id="chapter-btn" disabled>Full Chapter</button>
                </div>

                <!-- Quick Test Box -->
                <div class="test-box">
                    <h2>üß™ Quick Test</h2>
                    <textarea id="test-text"
                        placeholder="Enter test text here...">Welcome to Honora. This is a test of the text to speech system.</textarea>
                    <button class="primary" id="quick-test-btn" style="width: 100%;">Generate Test Audio</button>
                </div>

                <!-- Progress -->
                <div class="progress-container" id="progress-container">
                    <div class="muted">Processing...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <div id="progress-text" class="muted">0 / 0 sections</div>
                    <div class="log" id="log"></div>
                    <div id="audio-preview" style="margin-top: 12px;"></div>
                </div>
            </div>

            <!-- Middle: Chapters -->
            <div class="card">
                <h2>üìñ Chapters</h2>
                <div id="chapters-summary" class="muted" style="margin-bottom: 12px;">Select a book</div>
                <div class="chapter-list" id="chapter-list"></div>
            </div>

            <!-- Right: Sections -->
            <div class="card">
                <h2>üìù Sections</h2>
                <div id="sections-summary" class="muted" style="margin-bottom: 12px;">Select a chapter</div>
                <div class="section-list" id="section-list"></div>
            </div>
        </div>

        <!-- Job History Panel -->
        <div class="card" style="margin-top: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>üìã Job History</h2>
                <div>
                    <span id="history-succeeded" class="badge" style="background: var(--success); color: #0b1020;">‚úì
                        0</span>
                    <span id="history-failed" class="badge" style="background: var(--error); color: white;">‚úó 0</span>
                    <button class="secondary" onclick="loadHistory()" style="margin-left: 8px; padding: 6px 12px;">‚Üª
                        Refresh</button>
                </div>
            </div>
            <div id="job-history" style="max-height: 300px; overflow-y: auto; margin-top: 12px;">
                <div class="muted">No jobs yet</div>
            </div>
        </div>

        <!-- Segments & Spans Panel (TTS-First v3.1) -->
        <div class="card" style="margin-top: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>üîä Segments & Spans</h2>
                <div>
                    <span id="segments-count" class="badge">0 segments</span>
                    <span id="spans-count" class="badge" style="background: var(--accent-2);">0 spans</span>
                    <button class="secondary" onclick="loadSegments()" style="margin-left: 8px; padding: 6px 12px;">‚Üª
                        Refresh</button>
                </div>
            </div>
            <div id="segments-info" class="muted" style="margin: 12px 0;">Select a chapter to view segments</div>

            <!-- Build selector -->
            <div id="build-selector" style="display: none; margin-bottom: 12px;">
                <label class="muted">Build Version: </label>
                <select id="build-select" style="width: auto; display: inline-block; margin-bottom: 0;">
                    <option value="">Loading...</option>
                </select>
            </div>

            <!-- Segments list with span grouping -->
            <div id="segments-container" style="max-height: 400px; overflow-y: auto;">
                <div class="muted">No segments loaded</div>
            </div>

            <!-- Audio groups summary -->
            <div id="audio-groups-summary" style="margin-top: 12px; display: none;">
                <div class="muted">Audio Groups:</div>
                <div id="audio-groups-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
            </div>
        </div>
    </main>

    <script>
        // State
        let selectedEngine = 'piper';
        let selectedBook = null;
        let selectedChapter = null;
        let selectedVoice = '';
        let selectedLanguage = 'en';
        let chapters = [];
        let sections = [];
        let engines = [];

        // Elements
        const engineList = document.getElementById('engine-list');
        const bookSelect = document.getElementById('book-select');
        const voiceSelect = document.getElementById('voice-select');
        const languageSelect = document.getElementById('language-select');
        const chapterList = document.getElementById('chapter-list');
        const sectionList = document.getElementById('section-list');
        const chaptersSummary = document.getElementById('chapters-summary');
        const sectionsSummary = document.getElementById('sections-summary');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const logDiv = document.getElementById('log');
        const audioPreview = document.getElementById('audio-preview');

        // Load engines
        async function loadEngines() {
            try {
                const res = await fetch('/api/engines');
                engines = await res.json();

                engineList.innerHTML = engines.map(e => `
                    <div class="engine-card ${e.id === selectedEngine ? 'selected' : ''} ${!e.available ? 'unavailable' : ''}" 
                         data-id="${e.id}" ${!e.available ? 'disabled' : ''}>
                        <div class="engine-name">${e.name} ${!e.available ? 'üîí' : ''}</div>
                        <div class="engine-desc">${e.description}</div>
                    </div>
                `).join('');

                // Add click handlers
                document.querySelectorAll('.engine-card:not(.unavailable)').forEach(el => {
                    el.addEventListener('click', () => {
                        document.querySelectorAll('.engine-card').forEach(e => e.classList.remove('selected'));
                        el.classList.add('selected');
                        selectedEngine = el.dataset.id;
                        loadVoices(); // Reload voices for this engine
                    });
                });
            } catch (e) {
                engineList.innerHTML = '<div class="muted">Error loading engines</div>';
            }
        }

        // Check status
        async function checkStatus() {
            try {
                const res = await fetch('/api/status');
                const status = await res.json();

                const supabaseEl = document.getElementById('status-supabase');
                const queueEl = document.getElementById('status-queue');

                if (status.supabase_configured) {
                    supabaseEl.textContent = '‚úÖ Supabase';
                    supabaseEl.style.opacity = '1';
                } else {
                    supabaseEl.textContent = '‚ùå Supabase';
                    supabaseEl.style.opacity = '1';
                }

                queueEl.textContent = `üìã Queue: ${status.queue_size}`;
                queueEl.style.opacity = '1';
            } catch (e) {
                console.error('Status check failed:', e);
            }
        }

        // Load books
        async function loadBooks() {
            try {
                const res = await fetch('/api/books');
                const books = await res.json();
                bookSelect.innerHTML = '<option value="">Select a book...</option>' +
                    books.map(b => `<option value="${b.id}">${b.title} - ${b.author || 'Unknown'}</option>`).join('');
            } catch (e) {
                bookSelect.innerHTML = '<option value="">Error loading books</option>';
            }
        }

        // Load voices
        async function loadVoices() {
            try {
                const res = await fetch('/api/voices');
                const voices = await res.json();

                // Filter voices for current engine (or show all)
                const filtered = voices.filter(v => !v.engine || v.engine === selectedEngine || selectedEngine === 'xtts-local');

                if (filtered.length > 0) {
                    voiceSelect.innerHTML = filtered.map(v =>
                        `<option value="${v.id || v.url}">${v.name} (${v.source || v.engine})</option>`
                    ).join('');
                    selectedVoice = filtered[0].id || filtered[0].url;
                } else {
                    voiceSelect.innerHTML = '<option value="">No voices available</option>';
                }
            } catch (e) {
                voiceSelect.innerHTML = '<option value="">Error loading voices</option>';
            }
        }

        // Load chapters
        async function loadChapters(bookId) {
            try {
                const res = await fetch(`/api/books/${bookId}/chapters`);
                chapters = await res.json();

                chaptersSummary.textContent = `${chapters.length} chapters`;

                chapterList.innerHTML = chapters.map(ch => `
                    <div class="chapter-item" data-id="${ch.id}">
                        <div class="chapter-status"></div>
                        <div class="chapter-info">
                            <div class="chapter-title">${ch.title || `Chapter ${ch.chapter_index}`}</div>
                            <div class="chapter-meta">${ch.section_count || 0} sections</div>
                        </div>
                    </div>
                `).join('');

                document.querySelectorAll('.chapter-item').forEach(el => {
                    el.addEventListener('click', () => {
                        document.querySelectorAll('.chapter-item').forEach(e => e.classList.remove('selected'));
                        el.classList.add('selected');
                        loadSections(el.dataset.id);
                    });
                });
            } catch (e) {
                chapterList.innerHTML = '<div class="muted">Error loading chapters</div>';
            }
        }

        // Load sections
        async function loadSections(chapterId) {
            selectedChapter = chapterId;
            try {
                const res = await fetch(`/api/chapters/${chapterId}/sections`);
                sections = await res.json();

                sectionsSummary.textContent = `${sections.length} sections`;

                sectionList.innerHTML = sections.map((s, i) => `
                    <div class="section-item ${i === 0 ? 'title' : ''}">
                        <div class="section-header">
                            <span class="section-index">${i === 0 ? 'üé¨ Title' : `Section ${s.section_index}`}</span>
                            <span class="section-chars">${(s.full_text || s.text || '').length} chars</span>
                        </div>
                        <div class="section-text">${s.text || ''}</div>
                    </div>
                `).join('');

                document.getElementById('chapter-btn').disabled = false;
            } catch (e) {
                sectionList.innerHTML = '<div class="muted">Error loading sections</div>';
            }
        }

        // Start TTS job
        async function startTTS(sectionIds) {
            try {
                progressContainer.classList.add('active');
                progressFill.style.width = '0%';
                progressText.textContent = `Starting ${selectedEngine}...`;
                logDiv.textContent = '';
                audioPreview.innerHTML = '';

                const res = await fetch('/api/tts/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        section_ids: sectionIds,
                        engine: selectedEngine,
                        voice: selectedVoice,
                        language: selectedLanguage
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                log(`Job started: ${data.count} sections with ${data.engine}`);

                // Poll first job
                if (data.job_ids && data.job_ids.length > 0) {
                    pollStatus(data.job_ids[0]);
                }
            } catch (e) {
                log(`Error: ${e.message}`);
            }
        }

        // Quick test
        async function quickTest() {
            const text = document.getElementById('test-text').value;
            if (!text) {
                alert('Please enter some text');
                return;
            }

            try {
                progressContainer.classList.add('active');
                progressFill.style.width = '0%';
                progressText.textContent = `Testing ${selectedEngine}...`;
                logDiv.textContent = '';
                audioPreview.innerHTML = '';

                const res = await fetch('/api/tts/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        engine: selectedEngine,
                        voice: selectedVoice,
                        language: selectedLanguage
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                log(`Test started with ${data.engine}`);
                pollStatus(data.job_id);
            } catch (e) {
                log(`Error: ${e.message}`);
            }
        }

        // Poll job status
        async function pollStatus(jobId) {
            try {
                const res = await fetch(`/api/tts/status/${jobId}`);
                const data = await res.json();

                if (data.status === 'succeeded') {
                    progressFill.style.width = '100%';
                    progressText.textContent = `‚úÖ Complete in ${data.duration?.toFixed(1) || '?'}s with ${data.engine}`;
                    log('‚úÖ Audio generated!');

                    // Show audio player
                    if (data.output) {
                        audioPreview.innerHTML = `<audio controls src="${data.output}" style="width: 100%;"></audio>`;
                    }
                } else if (data.status === 'failed') {
                    progressFill.style.width = '100%';
                    progressText.textContent = '‚ùå Failed';
                    log(`Error: ${data.error}`);
                } else {
                    // Still processing
                    progressFill.style.width = '50%';
                    progressText.textContent = `‚è≥ ${data.status}...`;
                    setTimeout(() => pollStatus(jobId), 1000);
                }
            } catch (e) {
                log(`Poll error: ${e.message}`);
                setTimeout(() => pollStatus(jobId), 2000);
            }
        }

        function log(msg) {
            logDiv.textContent += msg + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Event Handlers
        bookSelect.addEventListener('change', () => {
            selectedBook = bookSelect.value;
            if (selectedBook) loadChapters(selectedBook);
        });

        voiceSelect.addEventListener('change', () => {
            selectedVoice = voiceSelect.value;
        });

        languageSelect.addEventListener('change', () => {
            selectedLanguage = languageSelect.value;
        });

        document.getElementById('test-1-btn').addEventListener('click', () => {
            if (sections.length > 0) startTTS([sections[0].id]);
        });

        document.getElementById('test-3-btn').addEventListener('click', () => {
            const ids = sections.slice(0, 3).map(s => s.id);
            if (ids.length > 0) startTTS(ids);
        });

        document.getElementById('chapter-btn').addEventListener('click', () => {
            const ids = sections.map(s => s.id);
            if (ids.length > 0) startTTS(ids);
        });

        document.getElementById('quick-test-btn').addEventListener('click', quickTest);

        // Job History Functions
        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const data = await res.json();

                document.getElementById('history-succeeded').textContent = `‚úì ${data.succeeded}`;
                document.getElementById('history-failed').textContent = `‚úó ${data.failed}`;

                const container = document.getElementById('job-history');

                if (data.jobs.length === 0) {
                    container.innerHTML = '<div class="muted">No jobs yet</div>';
                    return;
                }

                container.innerHTML = data.jobs.map(job => {
                    const isSuccess = job.status === 'succeeded';
                    const statusIcon = isSuccess ? '‚úÖ' : '‚ùå';
                    const statusColor = isSuccess ? 'var(--success)' : 'var(--error)';
                    const time = new Date(job.timestamp).toLocaleTimeString();

                    let retryBtn = '';
                    if (!isSuccess && job.paragraph_id) {
                        retryBtn = `<button class="secondary" onclick="retryJob('${job.paragraph_id}')" style="padding: 4px 10px; font-size: 12px;">üîÑ Retry</button>`;
                    }

                    return `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${statusColor};">
                            <span>${statusIcon}</span>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${job.text_preview || 'Unknown'}</div>
                                <div class="muted" style="font-size: 11px;">${job.engine} ¬∑ ${time}${job.duration ? ` ¬∑ ${job.duration}s` : ''}${job.error ? ` ¬∑ ${job.error}` : ''}</div>
                            </div>
                            ${retryBtn}
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Failed to load history:', e);
            }
        }

        async function retryJob(paragraphId) {
            try {
                log(`üîÑ Retrying paragraph ${paragraphId}...`);

                const res = await fetch(`/api/retry/${paragraphId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        engine: selectedEngine,
                        voice: selectedVoice,
                        language: selectedLanguage
                    })
                });

                const data = await res.json();

                if (data.job_id) {
                    log(`‚úÖ Retry queued: ${data.job_id}`);
                    // Poll for this job
                    pollJob(data.job_id, paragraphId);
                } else {
                    log(`‚ùå Retry failed: ${data.error}`);
                }

            } catch (e) {
                log(`‚ùå Retry error: ${e}`);
            }
        }

        async function pollJob(jobId, label) {
            const poll = setInterval(async () => {
                const res = await fetch(`/api/tts/status/${jobId}`);
                const data = await res.json();

                if (data.status === 'succeeded') {
                    clearInterval(poll);
                    log(`‚úÖ ${label}: Complete!`);
                    loadHistory();
                } else if (data.status === 'failed') {
                    clearInterval(poll);
                    log(`‚ùå ${label}: ${data.error}`);
                    loadHistory();
                }
            }, 2000);
        }

        // =========================================
        // Segments & Spans Functions (TTS-First v3.1)
        // =========================================

        let currentSegments = [];
        let currentSpans = [];
        let currentBuilds = [];

        async function loadSegments() {
            if (!selectedChapter) {
                document.getElementById('segments-info').textContent = 'Select a chapter first';
                return;
            }

            try {
                // Load segments, spans, builds, and audio groups in parallel
                const [segRes, spanRes, buildRes, groupRes] = await Promise.all([
                    fetch(`/api/chapters/${selectedChapter}/segments`),
                    fetch(`/api/chapters/${selectedChapter}/spans`),
                    fetch(`/api/chapters/${selectedChapter}/builds`),
                    fetch(`/api/chapters/${selectedChapter}/audio_groups`)
                ]);

                const segData = await segRes.json();
                const spanData = await spanRes.json();
                const buildData = await buildRes.json();
                const groupData = await groupRes.json();

                currentSegments = segData.segments || [];
                currentSpans = spanData.spans || [];
                currentBuilds = buildData.builds || [];

                // Update counts
                document.getElementById('segments-count').textContent = `${currentSegments.length} segments`;
                document.getElementById('spans-count').textContent = `${currentSpans.length} spans`;

                // Update info
                const buildInfo = segData.build_id ? `Build: v${buildData.builds?.find(b => b.id === segData.build_id)?.canonical_version || '?'}` : 'No build';
                document.getElementById('segments-info').textContent =
                    `Audio version: ${segData.audio_version || 'v1'} ¬∑ ${buildInfo}`;

                // Show build selector if multiple builds
                const buildSelector = document.getElementById('build-selector');
                const buildSelect = document.getElementById('build-select');
                if (currentBuilds.length > 1) {
                    buildSelector.style.display = 'block';
                    buildSelect.innerHTML = currentBuilds.map(b =>
                        `<option value="${b.id}" ${b.id === buildData.current_build_id ? 'selected' : ''}>
                            Version ${b.canonical_version} (${new Date(b.created_at).toLocaleDateString()})
                        </option>`
                    ).join('');
                } else {
                    buildSelector.style.display = 'none';
                }

                // Render segments grouped by spans
                renderSegmentsWithSpans(currentSegments, currentSpans);

                // Show audio groups
                if (groupData.groups && groupData.groups.length > 0) {
                    document.getElementById('audio-groups-summary').style.display = 'block';
                    const totalDuration = Math.round(groupData.total_duration_ms / 1000);
                    document.getElementById('audio-groups-list').innerHTML =
                        `<span class="badge">${groupData.count} groups ¬∑ ${totalDuration}s total</span>` +
                        groupData.groups.map(g =>
                            `<span class="badge" style="background: rgba(0,0,0,0.3);">
                                Group ${g.group_index}: ${Math.round(g.duration_ms / 1000)}s
                            </span>`
                        ).join('');
                } else {
                    document.getElementById('audio-groups-summary').style.display = 'none';
                }

            } catch (e) {
                document.getElementById('segments-info').textContent = `Error: ${e.message}`;
            }
        }

        function renderSegmentsWithSpans(segments, spans) {
            const container = document.getElementById('segments-container');

            if (segments.length === 0) {
                container.innerHTML = '<div class="muted">No segments for this chapter</div>';
                return;
            }

            // Create span lookup: segment_index -> paragraph_index
            const spanLookup = {};
            const spanColors = ['#7dd3fc', '#a855f7', '#34d399', '#fbbf24', '#f87171', '#818cf8'];
            spans.forEach((span, i) => {
                for (let idx = span.start_segment_index; idx <= span.end_segment_index; idx++) {
                    spanLookup[idx] = { paragraphIndex: span.paragraph_index, color: spanColors[i % spanColors.length] };
                }
            });

            // Render segments with span coloring
            container.innerHTML = segments.map((seg, i) => {
                const spanInfo = spanLookup[seg.segment_index];
                const borderColor = spanInfo ? spanInfo.color : 'var(--border)';
                const paragraphBadge = spanInfo ?
                    `<span style="background: ${spanInfo.color}20; color: ${spanInfo.color}; padding: 2px 6px; border-radius: 4px; font-size: 10px;">¬∂${spanInfo.paragraphIndex}</span>` : '';

                return `
                    <div style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; 
                                border-left: 3px solid ${borderColor}; margin-bottom: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-weight: 600; font-size: 12px; color: var(--accent);">
                                Segment ${seg.segment_index} ${paragraphBadge}
                            </span>
                            <span class="muted" style="font-size: 11px;">
                                ${seg.duration_ms || 0}ms ¬∑ ${(seg.text || '').length} chars
                            </span>
                        </div>
                        <div style="font-size: 13px; line-height: 1.4; color: var(--text);">
                            ${(seg.text || '').substring(0, 150)}${seg.text?.length > 150 ? '...' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update loadSections to also load segments
        const originalLoadSections = loadSections;
        loadSections = async function (chapterId) {
            await originalLoadSections(chapterId);
            loadSegments();
        };

        // Init
        loadEngines();
        checkStatus();
        loadBooks();
        loadVoices();
        loadHistory();  // Load history on startup
    </script>
</body>

</html>